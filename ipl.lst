     1                                  ; hello-os
     2                                  ; TAB=4
     3                                  
     4                                      ORG     0x7c00          ; このプログラムが何処によみこまれるのか
     5                                  
     6                                  ; 以下は標準的なFAT12フォーマットフロッピーディスクのための記述
     7                                  
     8 00000000 EB48                        JMP     entry
     9 00000002 90                          DB      0x90
    10 00000003 48454C4C4F49504C            DB      "HELLOIPL"
    11 0000000B 0002                        DW      512             ; 1セクタの大きさ                           (512にしなければならない)
    12 0000000D 01                          DB      1               ; クラスタの大きさ                          (1セクタにしなければならない)
    13 0000000E 0100                        DW      1               ; FATがどこから始まるか                     (普通は1セクタ目からにする)
    14 00000010 02                          DB      2               ; FATの個数                                 (2にしなければならない)
    15 00000011 E000                        DW      224             ; ルートディレクトリ領域の大きさ            (普通は224エントリにする)
    16 00000013 400B                        DW      2880            ; このドライブの大きさ                      (2880セクタにしなければならない)
    17 00000015 F0                          DB      0xf0            ; メディアタイプ                            (0xf0にしなければならない)
    18 00000016 0900                        DW      9               ; FAT領域の長さ                             (9セクタにしなければならない)
    19 00000018 1200                        DW      18              ; 1トラックにいくつのセクタがあるか         (18にしなければならない)
    20 0000001A 0200                        DW      2               ; ヘッドの数                                (2にしなければならない)
    21 0000001C 00000000                    DD      0               ; パーティションを使っていないのでここは必ず0
    22 00000020 400B0000                    DD      2880            ; このドライブの大きさをもう一度書く
    23 00000024 000029                      DB      0, 0, 0x29      ; よくわからないけどこの値にしておくといいらしい
    24 00000027 FFFFFFFF                    DD      0xffffffff      ; たぶんボリュームシリアル番号
    25 0000002B 48454C4C4F2D4F53            DB      "HELLO-OS"      ; ディスクの名前                            (11Byte)
    26 00000033 4641543132                  DB      "FAT12"         ; フォーマットの名前                        (8Byte)
    27 00000038 <res 00000012>              RESB    18              ; とりあえず18バイト開けておく
    27          ******************       warning: uninitialized space declared in .text section: zeroing
    28                                  
    29                                  ; Program Main Body
    30                                  
    31                                  entry:
    32 0000004A B80000                      MOV     AX,0            ; レジスタ初期化
    33 0000004D 8ED0                        MOV     SS,AX
    34 0000004F BC007C                      MOV     SP,0x7c00
    35 00000052 8ED8                        MOV     DS,AX
    36                                  
    37                                  ; Read disk
    38                                  
    39 00000054 B82008                      MOV     AX,0x0820
    40 00000057 8EC0                        MOV     ES,AX
    41 00000059 B500                        MOV     CH,0            ; シリンダ0
    42 0000005B B600                        MOV     DH,0            ; ヘッド0
    43 0000005D B102                        MOV     CL,2            ; セクタ2
    44                                  
    45                                  readloop:
    46 0000005F BE0000                      MOV     SI,0            ; 失敗回数を数えるレジスタ
    47                                  
    48                                  retry:
    49 00000062 B402                        MOV     AH,0x02         ; AH=0x02 : ディスク読み込み
    50 00000064 B001                        MOV     AL,1            ; 1セクタ
    51 00000066 BB0000                      MOV     BX,0
    52 00000069 B200                        MOV     DL,0x00         ; Aドライブ
    53 0000006B CD13                        INT     0x13            ; ディスクBIOS呼び出し
    54 0000006D 7310                        JNC     next            ; エラーが置きなければnextへ
    55 0000006F 83C601                      ADD     SI,1            ; SIに1を足す
    56 00000072 83FE05                      CMP     SI,5            ; SIと5を比較
    57 00000075 731A                        JAE     error           ; SI >= 5 だったらerrorへ
    58 00000077 B400                        MOV     AH,0x00
    59 00000079 B200                        MOV     DL,0x00         ; Aドライブ
    60 0000007B CD13                        INT     0x13            ; ドライブのリセット
    61 0000007D EBE3                        JMP     retry
    62                                  
    63                                  next:
    64 0000007F 8CC0                        MOV     AX,ES           ; アドレスを0x200進める
    65 00000081 83C020                      ADD     AX,0x0020
    66 00000084 8EC0                        MOV     ES,AX           ; ADD ES,0x020 という命令がないのでこうする
    67 00000086 80C101                      ADD     CL,1            ; CLに1を足す
    68 00000089 80F912                      CMP     CL,18           ; CLと18を比較
    69 0000008C 76D1                        JBE     readloop        ; CL <= 18 だったらreadloopへ
    70                                  
    71                                  fin:
    72 0000008E F4                          HLT                     ; 何かあるまでCPUを停止させる
    73 0000008F EBFD                        JMP     fin             ; 無限ループ
    74                                  
    75                                  error:
    76 00000091 BE[A600]                    MOV     SI,msg
    77                                  
    78                                  putloop:
    79 00000094 8A04                        MOV     AL,[SI]
    80 00000096 83C601                      ADD     SI,1            ; SIに1を足す
    81 00000099 3C00                        CMP     AL,0
    82 0000009B 74F1                        JE      fin
    83 0000009D B40E                        MOV     AH,0x0e         ; 一文字表示ファンクション
    84 0000009F BB0F00                      MOV     BX,15           ; カラーコード
    85 000000A2 CD10                        INT     0x10            ; ビデオBIOS呼び出し
    86 000000A4 EBEE                        JMP     putloop
    87                                  
    88                                  msg:
    89 000000A6 0A0A                        DB      0x0a, 0x0a      ; 改行を2つ
    90 000000A8 68656C6C6F2C20776F-         DB      "hello, world"
    90 000000B1 726C64             
    91 000000B4 0A                          DB      0x0a            ; 改行
    92 000000B5 00                          DB      0
    93                                  
    94                                      ;RESB    0x7dfe-$        ; エラーになる。。。
    95 000000B6 <res 00000148>              RESB	0x7dfe-0x7c00-($-$$)		; 0x7dfeまでを0x00で埋める命令
    95          ******************       warning: uninitialized space declared in .text section: zeroing
    96 000001FE 55AA                        DB      0x55, 0xaa
    97                                  
    98                                  
    99                                  ; 以下はブートセクタ以外の部分の記述
   100                                  
   101 00000200 F0FFFF0000000000            DB      0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
   102 00000208 <res 000011F8>              RESB    4600
   102          ******************       warning: uninitialized space declared in .text section: zeroing
   103 00001400 F0FFFF0000000000            DB      0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
   104 00001408 <res 00166BF8>              RESB    1469432
   104          ******************       warning: uninitialized space declared in .text section: zeroing
